<?php
session_start();
include "./config.php";
if($_GET['page'] == "login"){
    try{
        $input = json_decode(file_get_contents('php://input'), true);
    }
    catch(Exception $e){
        exit("<script>alert(`wrong input`);
        history.go(-1);</script>");
    }
    
    $db = dbconnect();
    
    if(strlen($input['id']) > 120) 
        exit("<script>alert(`userid too long`);history.go(-1);
        </script>");
    if(strlen($input['pw'] > 120))
        exit("<script>alert(`userpw too long`);history.go(-1);
        </script>");
    
    $id = mysqli_real_escape_string($db, $input['id']);
    $pw = mysqli_real_escape_string($db, $input['pw']);
    
    
    $query = "select id,pw from member where id='{$id}'";
    $result = mysqli_fetch_array(mysqli_query($db,$query));
    
    if($result['id'] && $result['pw'] == $pw){
        $_SESSION['id'] = $result['id'];
        exit("<script>alert(`login ok`);
        location.href=`/`;
        </script>");
    }
    else{ 
        exit("<script>alert(`login fail`);
        history.go(-1);</script>"); 
    }
}

if($_GET['page'] == "join"){
    try{
        $input = json_decode(file_get_contents('php://input'), true);
    }
    catch(Exception $e){
        exit("<script>alert(`wrong input`);
        history.go(-1);
        </script>");
    }
    
    $db = dbconnect();
    if(strlen($input['id']) > 120) 
        exit("<script>alert(`userid too long`);history.go(-1);
        </script>");
    if(strlen($input['email']) > 120) 
        exit("<script>alert(`email too long`);
        history.go(-1);
        </script>");
    if(!filter_var($input['email'],FILTER_VALIDATE_EMAIL)) 
        exit("<script>alert(`wrong email`);
        history.go(-1);
        </script>");
    if(strlen($input['pw'] > 120))
        exit("<script>alert(`userpw too long`);history.go(-1);
        </script>");
        
    $id = mysqli_real_escape_string($db, $input['id']);
    $pw = mysqli_real_escape_string($db, $input['pw']);
    $email = mysqli_real_escape_string($db, $input['email']);
    
    $query = "select id from member where id='{$id}'";
    $result = mysqli_fetch_array(mysqli_query($db,$query));
    
    if(!$result['id']){
        $query = "insert into member values('{$id}','{$email}','{$pw}','user')";
        mysqli_query($db,$query);
        exit("<script>alert(`join ok`);
        location.href=`/`;</script>");
    }
    else{
        exit("<script>alert(`Userid already existed`);
        history.go(-1);
        </script>");
    }
}

if($_GET['page'] == "upload"){
    if(!$_SESSION['id']){
        exit("<script>alert(`login plz`);
        history.go(-1);</script>");
    }
    
    if($_FILES['fileToUpload']['size'] >= 1024 * 1024 * 1){ 
        exit("<script>alert(`file is too big`);
        history.go(-1);
        </script>"); 
    } // file size limit(1MB). do not remove it.
    
    $extension = array_pop(explode(".",$_FILES['fileToUpload']['name']));
    $filename = basename($_FILES['fileToUpload']['name']);
    mkdir("/tmp/files");
    $filepath = "/tmp/files/".$filename;
    
    if(strtolower($extension) == "txt" || strtolower($extension) == "png") {
        move_uploaded_file($_FILES['fileToUpload']['tmp_name'], $filepath);
        exit("<script>alert(`upload ok`);
        location.href=`/`;
        </script>");
    }
    else{
        exit("<script>alert(`txt or png only`);
        history.go(-1);
        </script>");
    }
}

if($_GET['page'] == "download"){
    $filepath = "/tmp/files/";
    $file = basename($_GET['file']);
    $content = file_get_contents($filepath.$file);
    if(!$content){
        exit("<script>alert(`not exists file`);
        history.go(-1);
        </script>");
    }
    else{
        header("Content-Disposition: attachment;");
        echo $content;
        exit;
    }
}

if($_GET['page'] == "admin"){
    $db = dbconnect();
    $name = mysqli_real_escape_string($db,$_SESSION['id']);
    $result = mysqli_fetch_array(mysqli_query($db,"select id from member where id='{$name}'"));
    if($result['id'] == "admin"){
        echo file_get_contents("/flag"); // do not remove it.
    }
    else{
        exit("<script>alert(`admin only`);history.go(-1);</script>");
    }
}

/*  this is hint. you can remove it.
CREATE TABLE `member` (
    `id` varchar(120) NOT NULL,s
    `email` varchar(120) NOT NULL,
    `pw` varchar(120) NOT NULL,
    `type` varchar(5) NOT NULL
  );
  
  INSERT INTO `member` (`id`, `email`, `pw`, `type`)
      VALUES ('admin', '**SECRET**', '**SECRET**', 'admin');
*/

?>